<!DOCTYPE html>
<head>
  <meta charset="utf-8"/>
</head>
<script src="unthrottlers.js"></script>
<script>
  Number.prototype.times = function* times() {
    let i = 0; while (i++ < this) {
      yield i;
    }
  }
  let load = 0.5;
  let slice = 10;
  let period = 1000;
  let spread = "uniform";
  let work = period * load / slice;
  let paused = false;
  let pauseDelay = 5000;

  let running = false;
  let pending = 0;
  let done = 0;
  let timeouts = [];
  let handle = 0;

  let callback = function() {}

  function run() {
    let idle = period * (1 - load) / slice;
    let initialIdle = idle;
    let randm = false;

    if (spread === "cluster") {
      initialIdle = idle * slice - slice;
      idle = 1;
    } else if (spread === "random") {
      randm = true;
    }

    let first = true;
    let previousIdle = 0;
    for (let n of slice.times()) {
      let w = work;
      let i = first ? initialIdle : idle;
      if (randm) {
        let r = n !== slice ? (Math.random() - 0.5) * idle : 0;
        i += r - previousIdle;
        previousIdle = r
      }

      first = false;
      timeouts.push({work: w, idle: i});
    }

    runSlice()
  }

  function runSlice() {
    if (!running) {
      return;
    }

    if (paused) {
      alert("Press OK to resume");
      paused = false;
    }

    let slice = timeouts.pop();

    handle = function() {
      let work = slice.work;
      let idle = slice.idle;
      let start = performance.now();
      return setTimeout(_ => busy(work, idle, start), idle);
    }();
  }

  function busy(work, delay, start) {
    let now = performance.now();
    let end = now + work;

    callback(delay, now - start);

    while (performance.now() < end) {

    }

    if (timeouts.length) {
      runSlice();
    } else {
      run();
    }
  }

  function start() {
    let b = document.getElementById('toggle');
    b.value = "Stop";
    b.onclick = stop;
    running = true;

    run();
  }

  function stop() {
    let b = document.getElementById('toggle');
    b.value = "Start";
    b.onclick = start;
    running = false;
  }

  function norm(e) {
    switch(e.id) {
      case "load": {
        let v = +e.value;
        v = isNaN(v) && load || v;
        v = Math.min(Math.max(v, 0.0), 1.0);
        load = e.value = v;
        work = period * load / slice;
        break;
      }
      case "slice": {
        let v = +e.value;
        v = isNaN(v) && slice || v;
        v = Math.min(Math.max(v, 1), 100);
        slice = e.value = v;
        work = period * load / slice;
        break;
      }
      case "period": {
        let v = +e.value;
        v = isNaN(v) && slice || v;
        v = Math.min(Math.max(v, 1), 60000);
        period = e.value = v;
        work = period * load / slice;
        break;
      }
      case "select": {
        spread = e.options[e.selectedIndex].id;
        break;
      }
      case "pause": {
        let p = +e.value;
        v = isNaN(v) && pauseDelay || v;
        v = Math.min(Math.max(v, 1), 60000);
        pauseDelay = e.value = v;
      }
    }

    document.getElementById('work').innerText = work;
  }

  function reset(e) {
    norm(e);
    clearTimeout(handle);
    timeouts = [];

    if (running) {
      run();
    }
  }

  function init() {
    norm(document.getElementById('load'));
    norm(document.getElementById('slice'));
    norm(document.getElementById('period'));
    norm(document.getElementById('select'));

    let params = (new URL(document.location)).searchParams;
    document.getElementById('inframe').checked = params.get("inframe");
    document.getElementById('closeonclear').checked = params.get("close");

    if (params.get("test")) {
      runTest();
    }
  }

  function pause() {
    setTimeout(_ => paused = true, pauseDelay)
  }

  function runTest() {
    window.open("test.html");
  }

  function setCallback(c) {
    callback = c;
  }

  function runInFrame() {
    document.getElementById('inframe').checked = true;
  }

  addEventListener('load', init);
</script>
<table>
  <tr>
    <td>
      Load:
    </td>
    <td>
      <input type="text" id="load" onchange="reset(this)" value="0.5"></input> ms
    </td>
  </tr>
  <tr>
    <td>
      Slices#:
    </td>
    <td>
      <input type="text" id="slice" onchange="reset(this)" value="10"></input>
    </td>
  </tr>
  <tr>
    <td>
      Period:
    </td>
    <td>
      <input type="text" id="period" onchange="reset(this)" value="1000"></input> ms
    </td>
  </tr>
  <tr>
    <td>
      Spread:
    </td>
    <td>
      <select id="select" onchange="reset(this)">
        <option id="uniform">Uniform</option>
        <option id="random">Random</option>n
        <option id="cluster">Cluster</option>
      </select>
    </td>
  </tr>
  <tr>
    <td>
      Delay before pause:
    </td>
    <td>
      <input type="text" id="pause" onchange="norm(this)" value="5000"></input> ms
    </td>
  </tr>
  <tr>
    <td>
      <input id="toggle" type="button" value="Start" onclick="start()">
    </td>
    <td>
      <input type="button" value="Pause" onclick="pause()">
    </td>
  </tr>
  <tr>
    <td>
      Length of work:
    </td>
    <td>
      <span id="work"></span>ms
    </td>
  </tr>
</table>

<br/><br/>
<input type="button" onclick="addUnthrottler('gUM')" value="Add gUM"/>
<input type="button" onclick="addUnthrottler('iDB')" value="Add IndexedDB"/>
<input type="button" onclick="addUnthrottler('ws')" value="Add WebSocket"/>
<input type="button" onclick="addUnthrottler('rtc')" value="Add peer connection"/>
<input type="button" onclick="addUnthrottler('webaudio')" value="Add web audio"/>
<input type="button" onclick="addUnthrottler('audio')" value="Add audio element"/>
<input type="button" onclick="addUnthrottler('video')" value="Add video"/>
<input type="button" onclick="clearUnthrottler()" value="Clear unthrottler" />
<input type="button" onclick="runTest()" value="Run test" />
<br/>
In iframe <input type="checkbox" id="inframe" />
Close on clear <input type="checkbox" id="closeonclear" /><br />
Delay unthrottling <input type="checkbox" id="delayunthrottling" /><br />
<div id="container"></div>
