<!DOCTYPE html>
<head>
  <meta charset="utf-8"/>
</head>
<script src="unthrottlers.js"></script>
<script>
  Number.prototype.times = function* times() {
    let i = 0; while (i++ < this) {
      yield i;
    }
  }
  let load = 0.5;
  let slice = 10;
  let period = 1000;
  let spread = "uniform";
  let work = period * load / slice;
  let paused = false;
  let pauseDelay = 5000;

  let running = false;
  let pending = 0;
  let done = 0;
  let timeouts = [];
  let handle = 0;

  let callback = function() {}

  function run() {
    let idle = period * (1 - load) / slice;
    let initialIdle = idle;
    let randm = false;

    if (spread === "cluster") {
      initialIdle = idle * slice - slice;
      idle = 1;
    } else if (spread === "random") {
      randm = true;
    }

    let first = true;
    let previousIdle = 0;
    for (let n of slice.times()) {
      let w = work;
      let i = first ? initialIdle : idle;
      if (randm) {
        let r = n !== slice ? (Math.random() - 0.5) * idle : 0;
        i += r - previousIdle;
        previousIdle = r
      }

      first = false;
      timeouts.push({work: w, idle: i});
    }

    runSlice()
  }

  function runSlice() {
    if (!running) {
      return;
    }

    if (paused) {
      alert("Press OK to resume");
      paused = false;
    }

    let slice = timeouts.pop();

    handle = function() {
      let work = slice.work;
      let idle = slice.idle;
      let start = performance.now();
      return setTimeout(_ => busy(work, idle, start), idle);
    }();
  }

  function busy(work, delay, start) {
    let now = performance.now();
    let end = now + work;

    callback(work, delay, now - start);

    while (performance.now() < end) {

    }

    if (timeouts.length) {
      runSlice();
    } else {
      run();
    }
  }

  function start() {
    let b = document.getElementById('toggle');
    b.value = "Stop";
    b.onclick = stop;
    running = true;

    run();
  }

  function stop() {
    let b = document.getElementById('toggle');
    b.value = "Start";
    b.onclick = start;
    running = false;
    clearTimeout(handle);
    timeouts = [];
    clearUnthrottler()

    let url = new URL(document.location);
    let params = url.searchParams;
    params.set("inframe", document.getElementById('inframe').checked);
    params.set("close", document.getElementById('closeonclear').checked);
    params.set("test", false);
    params.set("load", load);
    params.set("slice", slice);
    params.set("period", period);
    params.set("spread", spread);
    url.hash = "#" + Math.random();

    document.location = url;
  }

  function norm(e, d) {
    switch(e.id) {
      case "load": {
        let v = d || +e.value;
        v = isNaN(v) && load || v;
        v = Math.min(Math.max(v, 0.0), 1.0);
        load = e.value = v;
        work = period * load / slice;
        e.value = v;
        break;
      }
      case "slice": {
        let v = d || +e.value;
        v = isNaN(v) && slice || v;
        v = Math.min(Math.max(v, 1), 100);
        slice = e.value = v;
        work = period * load / slice;
        break;
      }
      case "period": {
        let v = d || +e.value;
        v = isNaN(v) && slice || v;
        v = Math.min(Math.max(v, 1), 60000);
        period = e.value = v;
        work = period * load / slice;
        break;
      }
      case "select": {
        spread = d || e.options[e.selectedIndex].id;
        e.selectedIndex = e.options.namedItem(spread).index;
        break;
      }
      case "pause": {
        let p = +e.value;
        v = isNaN(v) && pauseDelay || v;
        v = Math.min(Math.max(v, 1), 60000);
        pauseDelay = e.value = v;
      }
    }

    document.getElementById('work').innerText = work;
  }

  function reset(e) {
    norm(e);
    clearTimeout(handle);
    timeouts = [];

    if (running) {
      run();
    }
  }

  function init() {
    let params = (new URL(document.location)).searchParams;
    document.getElementById('inframe').checked = params.get("inframe");
    document.getElementById('closeonclear').checked = params.get("close");

    norm(document.getElementById('load'), +params.get("load"));
    norm(document.getElementById('slice'), +params.get("slice"));
    norm(document.getElementById('period'), +params.get("period"));
    norm(document.getElementById('select'), params.get("spread"));

    if (params.get("test") === "true") {
      window.open("test.html");
    }
  }

  function pause() {
    setTimeout(_ => paused = true, pauseDelay)
  }

  function runTest() {
    let url = new URL(document.location);
    let params = url.searchParams;
    params.set("inframe", document.getElementById('inframe').checked);
    params.set("close", document.getElementById('closeonclear').checked);
    params.set("test", true);
    params.set("load", load);
    params.set("slice", slice);
    params.set("period", period);
    params.set("spread", spread);
    url.hash = "#" + Math.random();

    document.location = url;
  }

  function setCallback(c) {
    callback = c;
  }

  function runInFrame() {
    document.getElementById('inframe').checked = true;
  }

  function resetLocation() {
    document.location = "index.html";
  }

  addEventListener('load', init);
</script>
<table>
  <tr>
    <td>
      Load:
    </td>
    <td>
      <input type="text" id="load" onchange="reset(this)" value="0.5"></input> ms
    </td>
  </tr>
  <tr>
    <td>
      Slices#:
    </td>
    <td>
      <input type="text" id="slice" onchange="reset(this)" value="10"></input>
    </td>
  </tr>
  <tr>
    <td>
      Period:
    </td>
    <td>
      <input type="text" id="period" onchange="reset(this)" value="1000"></input> ms
    </td>
  </tr>
  <tr>
    <td>
      Spread:
    </td>
    <td>
      <select id="select" onchange="reset(this)">
        <option id="uniform">Uniform</option>
        <option id="random">Random</option>n
        <option id="cluster">Cluster</option>
      </select>
    </td>
  </tr>
  <tr>
    <td>
      Delay before pause:
    </td>
    <td>
      <input type="text" id="pause" onchange="norm(this)" value="5000"></input> ms
    </td>
  </tr>
  <tr>
    <td>
      <input id="toggle" type="button" value="Start" onclick="start()">
    </td>
    <td>
      <input type="button" value="Pause" onclick="pause()">
    </td>
  </tr>
  <tr>
    <td>
      Length of work:
    </td>
    <td>
      <span id="work"></span>ms
    </td>
  </tr>
</table>

<br/><br/>
<input type="button" onclick="addUnthrottler('gUM')" value="Add gUM"/>
<input type="button" onclick="addUnthrottler('iDB')" value="Add IndexedDB"/>
<input type="button" onclick="addUnthrottler('ws')" value="Add WebSocket"/>
<input type="button" onclick="addUnthrottler('rtc')" value="Add peer connection"/>
<input type="button" onclick="addUnthrottler('webaudio')" value="Add web audio"/>
<input type="button" onclick="addUnthrottler('audio')" value="Add audio element"/>
<input type="button" onclick="addUnthrottler('video')" value="Add video"/>
<input type="button" onclick="clearUnthrottler()" value="Clear unthrottler" />
<br/>
In iframe <input type="checkbox" id="inframe" />
Close on clear <input type="checkbox" id="closeonclear" /><br />
Delay unthrottling <input type="checkbox" id="delayunthrottling" /><br />
<div id="container"></div><br /><br />

<input type="button" onclick="resetLocation()" value="Clear" />
<input type="button" onclick="runTest()" value="Run test" />
